Build_URP_Terrain_Linux_Vulkan_Standalone_mono_Linear_trunk_auto:
  name: Build URP_Terrain on Linux_Vulkan_mono_Linear_Standalone_build_Player on version trunk auto
  agent:
    type: Unity::VM
    image: package-ci/ubuntu:stable
    flavor: b1.xlarge
  variables:
    UPM_REGISTRY: https://artifactory-slo.bf.unity3d.com/artifactory/api/npm/upm-candidates
    CUSTOM_REVISION: "{{trunk.changeset.id}}"
    CACHE_ARGS: "{{cache.flags}}"
    UTR_VERSION: "current"
    TEST_FILTER: .*
  commands:
    - command: curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr --output utr
      retries: 2
    - command: chmod +x utr
    - command: sudo rm -f /etc/apt/sources.list /etc/apt/sources.list.d/{nodesource,teamviewer,deadsnakes-ubuntu-ppa-}*
    - command: curl -L https://artifactory.prd.it.unity3d.com/artifactory/api/gpg/key/public | sudo apt-key add -
    - command: sudo sh -c "echo 'deb https://artifactory.prd.it.unity3d.com/artifactory/unity-apt-local bionic main' > /etc/apt/sources.list.d/unity.list"
    - command: sudo apt update
    - command: sudo apt install unity-downloader-cli
      retries: 2
    - command: sudo unity-downloader-cli --source-file unity_revision.txt -c editor -c il2cpp  --wait --published-only
      retries: 2
    - command: |5-
                export GIT_REVISIONDATE=`git rev-parse HEAD | git show -s --format=%cI`
                DISPLAY=:0.0 ./utr --artifacts_path=TestProjects/UniversalGraphicsTest_Terrain/test-results --build-only --editor-location=.Editor --extra-editor-arg="-colorspace=Linear" --extra-editor-arg="-executemethod" --extra-editor-arg="SetupProject.ApplySettings" --extra-editor-arg="vulkan" --extra-editor-arg="Linear" --extra-editor-arg="-playergraphicsapi=Vulkan" --platform=StandaloneLinux64 --player-save-path=players --scripting-backend=Mono2x --suite=playmode --testfilter=$TEST_FILTER --testproject=./TestProjects/UniversalGraphicsTest_Terrain --timeout=3000
  after:
    - command: pip3 install ant_instability_detection --index-url https://artifactory.prd.cds.internal.unity3d.com/artifactory/api/pypi/pypi/simple --upgrade || exit 0
    - command: find_instabilities || exit 0
  artifacts:
    logs:
      paths:
        - "**/test-results/**"
        - "TestProjects/UniversalGraphicsTest_Terrain/Logs/*.log"
    players:
      paths:
        - "players*/**"
  dependencies:
    - path: .yamato/_editor_priming.yml#editor:priming:trunk:Linux
      rerun: on_new_revision
  triggers:
    recurring:
      - branch: ant/341/investigate-server-cache-instabilities
        frequency: 0/5 * * ?
